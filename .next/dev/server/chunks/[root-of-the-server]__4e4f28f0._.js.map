{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/job/meowcat/app/api/chat/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { from, of } from \"rxjs\";\r\nimport { concatMap, delay, map } from \"rxjs/operators\";\r\nimport { Observable } from \"rxjs\";\r\n\r\n// 这是一个 helper 函数，用来解析上游的流并转换为我们要的格式\r\nfunction iteratorToStream(iterator: any) {\r\n  const encoder = new TextEncoder();\r\n  const decoder = new TextDecoder();\r\n\r\n  return new ReadableStream({\r\n    async start(controller) {\r\n      for await (const chunk of iterator) {\r\n        // chunk 是 Uint8Array，需要解码成字符串\r\n        const text = decoder.decode(chunk);\r\n        const lines = text.split(\"\\n\");\r\n\r\n        for (const line of lines) {\r\n          if (line.startsWith(\"data: \") && line !== \"data: [DONE]\") {\r\n            try {\r\n              // 1. 解析 SiliconFlow/OpenAI 的原始数据\r\n              const jsonStr = line.replace(\"data: \", \"\");\r\n              const json = JSON.parse(jsonStr);\r\n\r\n              // 2. 提取真正的文本内容 (GLM/OpenAI 格式通常在 choices[0].delta.content)\r\n              const content = json.choices?.[0]?.delta?.content || \"\";\r\n\r\n              if (content) {\r\n                // 3. 重新包装成你的前端能看懂的格式: { content: \"...\" }\r\n                const payload = JSON.stringify({ content: content });\r\n                // 4. 发送给前端\r\n                controller.enqueue(encoder.encode(`data: ${payload}\\n\\n`));\r\n              }\r\n            } catch (e) {\r\n              console.error(\"Error parsing stream:\", e);\r\n            }\r\n          }\r\n        }\r\n      }\r\n      // 结束时发送 Done 标记\r\n      controller.enqueue(encoder.encode(\"data: [DONE]\\n\\n\"));\r\n      controller.close();\r\n    },\r\n  });\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  // 1. 获取前端发来的用户消息\r\n  const { message } = await req.json();\r\n\r\n  const apiKey = process.env.SILICONFLOW_API_KEY;\r\n\r\n  if (!apiKey) {\r\n    return NextResponse.json({ error: \"API Key not found\" }, { status: 500 });\r\n  }\r\n\r\n  // 2. 呼叫 SiliconFlow 接口\r\n  const response = await fetch(\r\n    \"https://api.siliconflow.cn/v1/chat/completions\",\r\n    {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        Authorization: `Bearer ${apiKey}`,\r\n      },\r\n      // 关键：开启 stream: true，让 AI 边想边说\r\n      body: JSON.stringify({\r\n        model: \"deepseek-ai/DeepSeek-R1-0528-Qwen3-8B\", // 或者是你喜欢的其他模型\r\n        messages: [\r\n          { role: \"system\", content: \"你是一个有用的助手\" },\r\n          { role: \"user\", content: message }, // 使用真实的用户输入\r\n        ],\r\n        stream: true, // <--- 重点！\r\n      }),\r\n    },\r\n  );\r\n\r\n  if (!response.ok) {\r\n    return NextResponse.json(\r\n      { error: \"API call failed\" },\r\n      { status: response.status },\r\n    );\r\n  }\r\n\r\n  if (!response.body) {\r\n    return NextResponse.json({ error: \"No response body\" }, { status: 500 });\r\n  }\r\n\r\n  // 3. 将上游的流经过转换后，返回给前端\r\n  // 这里的 response.body 是一个原始的 ReadableStream\r\n  const stream = iteratorToStream(response.body as any);\r\n\r\n  return new Response(stream, {\r\n    headers: {\r\n      \"Content-Type\": \"text/event-stream\",\r\n      \"Cache-Control\": \"no-cache\",\r\n      Connection: \"keep-alive\",\r\n    },\r\n  });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAKA,oCAAoC;AACpC,SAAS,iBAAiB,QAAa;IACrC,MAAM,UAAU,IAAI;IACpB,MAAM,UAAU,IAAI;IAEpB,OAAO,IAAI,eAAe;QACxB,MAAM,OAAM,UAAU;YACpB,WAAW,MAAM,SAAS,SAAU;gBAClC,8BAA8B;gBAC9B,MAAM,OAAO,QAAQ,MAAM,CAAC;gBAC5B,MAAM,QAAQ,KAAK,KAAK,CAAC;gBAEzB,KAAK,MAAM,QAAQ,MAAO;oBACxB,IAAI,KAAK,UAAU,CAAC,aAAa,SAAS,gBAAgB;wBACxD,IAAI;4BACF,iCAAiC;4BACjC,MAAM,UAAU,KAAK,OAAO,CAAC,UAAU;4BACvC,MAAM,OAAO,KAAK,KAAK,CAAC;4BAExB,2DAA2D;4BAC3D,MAAM,UAAU,KAAK,OAAO,EAAE,CAAC,EAAE,EAAE,OAAO,WAAW;4BAErD,IAAI,SAAS;gCACX,yCAAyC;gCACzC,MAAM,UAAU,KAAK,SAAS,CAAC;oCAAE,SAAS;gCAAQ;gCAClD,WAAW;gCACX,WAAW,OAAO,CAAC,QAAQ,MAAM,CAAC,CAAC,MAAM,EAAE,QAAQ,IAAI,CAAC;4BAC1D;wBACF,EAAE,OAAO,GAAG;4BACV,QAAQ,KAAK,CAAC,yBAAyB;wBACzC;oBACF;gBACF;YACF;YACA,gBAAgB;YAChB,WAAW,OAAO,CAAC,QAAQ,MAAM,CAAC;YAClC,WAAW,KAAK;QAClB;IACF;AACF;AAEO,eAAe,KAAK,GAAgB;IACzC,iBAAiB;IACjB,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAI,IAAI;IAElC,MAAM,SAAS,QAAQ,GAAG,CAAC,mBAAmB;IAE9C,IAAI,CAAC,QAAQ;QACX,OAAO,+PAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAoB,GAAG;YAAE,QAAQ;QAAI;IACzE;IAEA,uBAAuB;IACvB,MAAM,WAAW,MAAM,MACrB,kDACA;QACE,QAAQ;QACR,SAAS;YACP,gBAAgB;YAChB,eAAe,CAAC,OAAO,EAAE,QAAQ;QACnC;QACA,+BAA+B;QAC/B,MAAM,KAAK,SAAS,CAAC;YACnB,OAAO;YACP,UAAU;gBACR;oBAAE,MAAM;oBAAU,SAAS;gBAAY;gBACvC;oBAAE,MAAM;oBAAQ,SAAS;gBAAQ;aAClC;YACD,QAAQ;QACV;IACF;IAGF,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,OAAO,+PAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAkB,GAC3B;YAAE,QAAQ,SAAS,MAAM;QAAC;IAE9B;IAEA,IAAI,CAAC,SAAS,IAAI,EAAE;QAClB,OAAO,+PAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAmB,GAAG;YAAE,QAAQ;QAAI;IACxE;IAEA,sBAAsB;IACtB,0CAA0C;IAC1C,MAAM,SAAS,iBAAiB,SAAS,IAAI;IAE7C,OAAO,IAAI,SAAS,QAAQ;QAC1B,SAAS;YACP,gBAAgB;YAChB,iBAAiB;YACjB,YAAY;QACd;IACF;AACF","debugId":null}}]
}