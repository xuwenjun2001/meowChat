{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///D:/job/meowcat/app/api/chat/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { from, of } from \"rxjs\";\r\nimport { concatMap, delay, map } from \"rxjs/operators\";\r\nimport { Observable } from \"rxjs\";\r\n\r\nexport async function POST(req: Request) {\r\n  const { message } = await req.json();\r\n\r\n  const encoder = new TextEncoder();\r\n\r\n  const MESSAGES = `${message}。夜阑卧听风吹雨，铁马冰河入梦来。东风夜放花千树，更吹落，星如雨。宝马雕车香满路。凤箫声动，玉壶光转，一夜鱼龙舞。蛾儿雪柳黄金缕，笑语盈盈暗香去。众里寻他千百度，蓦然回首，那人却在，灯火阑珊处。`;\r\n\r\n  const chars$ = from(MESSAGES.split(\"\"));\r\n\r\n  const stream = new ReadableStream({\r\n    async start(controller) {\r\n      // 订阅 RxJS Observable\r\n      chars$\r\n        .pipe(\r\n          concatMap((char) =>\r\n            new Observable((subscriber) => {\r\n              subscriber.next(char);\r\n              subscriber.complete();\r\n            }).pipe(delay(80)),\r\n          ),\r\n        )\r\n        .subscribe({\r\n          next: (char) => {\r\n            // 发送 SSE 格式数据\r\n            const data = JSON.stringify({ content: char });\r\n            controller.enqueue(encoder.encode(`data: ${data}\\n\\n`));\r\n          },\r\n          complete: () => {\r\n            // 发送结束标记\r\n            controller.enqueue(encoder.encode(\"data: [DONE]\\n\\n\"));\r\n            controller.close();\r\n          },\r\n          error: (err) => {\r\n            console.error(\"Stream error:\", err);\r\n            controller.error(err);\r\n          },\r\n        });\r\n    },\r\n  });\r\n\r\n  return new Response(stream, {\r\n    headers: {\r\n      \"Content-Type\": \"text/event-stream\",\r\n      \"Cache-Control\": \"no-cache\",\r\n      Connection: \"keep-alive\",\r\n    },\r\n  });\r\n}\r\n"],"names":[],"mappings":";;;;AACA;AACA;;;;AAGO,eAAe,KAAK,GAAY;IACrC,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAI,IAAI;IAElC,MAAM,UAAU,IAAI;IAEpB,MAAM,WAAW,GAAG,QAAQ,iGAAiG,CAAC;IAE9H,MAAM,SAAS,IAAA,uMAAI,EAAC,SAAS,KAAK,CAAC;IAEnC,MAAM,SAAS,IAAI,eAAe;QAChC,MAAM,OAAM,UAAU;YACpB,qBAAqB;YACrB,OACG,IAAI,CACH,IAAA,yNAAS,EAAC,CAAC,OACT,IAAI,6MAAU,CAAC,CAAC;oBACd,WAAW,IAAI,CAAC;oBAChB,WAAW,QAAQ;gBACrB,GAAG,IAAI,CAAC,IAAA,qNAAK,EAAC,OAGjB,SAAS,CAAC;gBACT,MAAM,CAAC;oBACL,cAAc;oBACd,MAAM,OAAO,KAAK,SAAS,CAAC;wBAAE,SAAS;oBAAK;oBAC5C,WAAW,OAAO,CAAC,QAAQ,MAAM,CAAC,CAAC,MAAM,EAAE,KAAK,IAAI,CAAC;gBACvD;gBACA,UAAU;oBACR,SAAS;oBACT,WAAW,OAAO,CAAC,QAAQ,MAAM,CAAC;oBAClC,WAAW,KAAK;gBAClB;gBACA,OAAO,CAAC;oBACN,QAAQ,KAAK,CAAC,iBAAiB;oBAC/B,WAAW,KAAK,CAAC;gBACnB;YACF;QACJ;IACF;IAEA,OAAO,IAAI,SAAS,QAAQ;QAC1B,SAAS;YACP,gBAAgB;YAChB,iBAAiB;YACjB,YAAY;QACd;IACF;AACF","debugId":null}}]
}